<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archetype Resonance Index | Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-pixel { font-family: 'Press Start 2P', cursive; }
        
        .domain-mentis { --domain-color: #6366f1; }
        .domain-imperii { --domain-color: #ec4899; }
        .domain-operis { --domain-color: #f59e0b; }
        .domain-foederis { --domain-color: #10b981; }
        
        .domain-color { color: var(--domain-color); }
        .border-domain-color { border-color: var(--domain-color); }
        
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #a5b4fc; cursor: pointer; border-radius: 50%; }
        .slider:hover::-webkit-slider-thumb { background: #6366f1; }
        
        .ranking-item { transition: all 0.2s ease-in-out; }

        .pixel-box {
            border: 4px solid #4f4f4f;
            box-shadow: 
                inset -4px -4px 0px 0px #2f2f2f,
                inset 4px 4px 0px 0px #a8a8a8;
            background-color: #7b7b7b;
            image-rendering: pixelated;
        }
        .pixel-box-inner {
            border: 4px solid #4f4f4f;
            background-color: #c6c6c6;
            color: #1e1e1e;
        }

        /* UPDATED: Simplified sprite container */
        #symbol-sprite-container {
            width: 96px;
            height: 96px;
            animation: idle-bob 1.5s ease-in-out infinite;
            image-rendering: pixelated;
        }

        /* UPDATED: Reverted to simple idle-bob animation */
        @keyframes idle-bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">
    <div id="app" class="w-full max-w-2xl mx-auto" v-cloak>
        
        <div v-if="screen === 'start'" class="text-center bg-gray-800 p-8 rounded-2xl shadow-2xl">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Archetype Resonance Index</h1>
            <button @click="startTest" class="mt-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg" :disabled="isSubmitting">{{ isSubmitting ? 'Initializing...' : 'Begin Assessment' }}</button>
        </div>

        <div v-if="screen === 'assessment' || screen === 'archetypeAssessment'" class="bg-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl">
            <div class="mb-8">
                <h1 class="text-center text-2xl font-bold text-indigo-300 mb-4">Archetype Resonance Index</h1>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-400">Question {{ questionNumber }} / 25</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div class="bg-indigo-600 h-2.5 rounded-full" :style="{ width: (questionNumber / 25) * 100 + '%' }"></div>
                </div>
            </div>
            <h2 class="text-xl font-semibold text-white mb-2">Scenario:</h2>
            <p class="text-gray-300 mb-8">{{ currentQuestion.scenario }}</p>

            <div v-if="screen === 'assessment'" class="space-y-6">
                <div v-for="(option, index) in currentQuestion.options" :key="index" class="p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                    <label class="block mb-2 text-md font-medium text-white">{{ option.text }}</label>
                    <div class="flex items-center space-x-4">
                        <input type="range" v-model.number="points[index]" min="0" max="10" @input="updatePoints(index)" class="w-full h-2 bg-gray-600 rounded-lg slider">
                        <span class="text-lg font-bold w-12 text-center text-indigo-300">{{ points[index] }}</span>
                    </div>
                </div>
            </div>

            <div v-if="screen === 'archetypeAssessment'" class="space-y-2">
                <p class="text-gray-400 mb-4 text-center">Rank the following from <strong>Most like you</strong> (top) to <strong>Least like you</strong> (bottom).</p>
                <div v-for="(option, index) in rankedOptions" :key="option.archetype" class="ranking-item flex items-center justify-between p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                    <span class="font-bold text-lg mr-4 text-indigo-300">{{ index + 1 }}</span>
                    <span class="flex-grow text-white">{{ option.text }}</span>
                    <div class="flex flex-col space-y-1 ml-4">
                        <button @click="moveRank(index, -1)" :disabled="index === 0" class="p-1 rounded-full bg-gray-600 hover:bg-indigo-500 disabled:opacity-50"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg></button>
                        <button @click="moveRank(index, 1)" :disabled="index === rankedOptions.length - 1" class="p-1 rounded-full bg-gray-600 hover:bg-indigo-500 disabled:opacity-50"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button @click="submitAnswer" :disabled="isSubmitting || (screen === 'assessment' && totalPoints !== 10)" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg disabled:bg-gray-600">Submit</button>
            </div>
        </div>
        
        <div v-if="screen === 'finalResults'" class="bg-gray-800 p-4 md:p-6 rounded-2xl shadow-2xl pixel-box">
            <div class="pixel-box-inner p-4 md:p-6">
                <h1 class="font-pixel text-xl md:text-2xl text-center mb-6">ARCHETYPE ACQUIRED</h1>
                <div class="flex flex-col items-center gap-4">
                    <!-- UPDATED: New container for the symbol sprite -->
                    <div id="symbol-sprite-container" :class="'domain-' + primaryDomain.id" :style="{'--character-color': `var(--domain-color)`}">
                        <div v-html="archetypeSprite" class="w-full h-full"></div>
                    </div>
                    <div class="text-center w-full">
                        <p class="font-pixel text-md mb-2">
                            ARCHETYPE: <span class="domain-color" :class="'domain-' + primaryDomain.id">{{ finalArchetype }}</span>
                        </p>
                        <p class="mb-4 text-sm">{{ archetypeInfo.description }}</p>
                        <p class="font-pixel text-md mb-2">
                            PRIMARY DOMAIN: <span class="domain-color" :class="'domain-' + primaryDomain.id">{{ primaryDomain.name }}</span>
                        </p>
                        <p class="mb-4 text-sm">{{ domainInfo.description }}</p>
                    </div>
                </div>
                <button @click="resetTest" class="mt-8 font-pixel text-center w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 border-2 border-gray-500 shadow-md">RETAKE ASSESSMENT</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, computed } = Vue;

        const app = createApp({
            setup() {
                const screen = ref('start');
                const isSubmitting = ref(false);
                const sessionId = ref(null);
                const currentQuestion = ref(null);
                const questionNumber = ref(1);
                const points = ref([]);
                const rankedOptions = ref([]);
                const primaryDomain = ref(null);
                const finalArchetype = ref(null);
                const profileData = ref(null);

                // --- UPDATED: New Sprite Library with Symbols ---
                const spriteLibrary = {
                    // MENTIS
                    analyst: `<path d="M4,12 h16 M4,12 l4,-4 M4,12 l4,4 M20,12 l-4,-4 M20,12 l-4,4 M12,4 v16" stroke="currentColor" stroke-width="2" fill="none" />`,
                    innovator: `<path d="M12,4 L16,12 L8,12 Z" fill="currentColor" /><circle cx="12" cy="18" r="2" fill="currentColor"/>`,
                    specialist: `<path d="M8,4 h8 v4 h-8z M4,8 h16 v4 h-16z M8,12 h8 v4 h-8z M12,16 v4" stroke="currentColor" stroke-width="2" fill="none" />`,
                    // IMPERII
                    commander: `<path d="M4 4 L12 12 L20 4 L12 8 Z" fill="currentColor" />`,
                    vanguard: `<path d="M4 4 L20 12 L4 20 Z" fill="currentColor" />`,
                    pathfinder: `<circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2" fill="none" /><path d="M12,4 v-2 M12,20 v2 M4,12 h-2 M20,12 h2" stroke="currentColor" stroke-width="2" />`,
                    advocate: `<path d="M12,4 L20,20 L4,20 Z" fill="currentColor" /><path d="M12,4 L12 12" stroke="#FFF" stroke-width="2"/>`,
                    // OPERIS
                    forgemaster: `<path d="M4,14 h16 v2 h-16z M8,12 l-2,-6 h4z M16,12 l2,-6 h-4z" fill="currentColor" /><path d="M12,4 v6" stroke="currentColor" stroke-width="2"/>`,
                    finisher: `<circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2" /><path d="M12,4 L16,8 M12,12 h8 M12,20 L8,16" stroke="currentColor" stroke-width="2" />`,
                    orchestrator: `<path d="M4,4 v16 M8,4 v16 M12,4 v16 M16,4 v16 M20,4 v16" stroke="currentColor" stroke-width="1.5" />`,
                    // FOEDERIS
                    ambassador: `<path d="M4,8 h16 v8 h-16z" fill="none" stroke="currentColor" stroke-width="2" /><path d="M8,8 l4,-4 l4,4" fill="none" stroke="currentColor" stroke-width="2" />`,
                    inspirer: `<circle cx="12" cy="12" r="4" fill="currentColor" /><path d="M12,4 v-2 M12,20 v2 M4,12 h-2 M20,12 h2 M7,7 l-2,-2 M17,17 l2,2 M7,17 l-2,2 M17,7 l2,-2" stroke="currentColor" stroke-width="2"/>`,
                    peacekeeper: `<path d="M12,4 C4,4 4,20 12,20 S20,4 12,4 Z" fill="currentColor" stroke="#FFF" stroke-width="1.5" />`,
                    guardian: `<path d="M4,4 h16 v6 l-8,4 l-8,-4z M4,10 v10 h16 v-10" fill="currentColor" />`,
                    shepherd: `<path d="M12,4 C16,4 16,8 12,8 S8,4 12,4z M12,8 v16" stroke="currentColor" stroke-width="2" fill="none" />`
                };
                
                const archetypeSprite = computed(() => {
                    if (!finalArchetype.value) return '';
                    const key = finalArchetype.value.toLowerCase();
                    const symbolSVG = spriteLibrary[key] || '';
                    return `<svg viewBox="0 0 24 24" class="w-full h-full">${symbolSVG}</svg>`;
                });
                
                const totalPoints = computed(() => points.value ? points.value.reduce((sum, p) => sum + p, 0) : 0);
                const domainInfo = computed(() => primaryDomain.value && profileData.value ? { description: profileData.value.domainDescription } : {});
                const archetypeInfo = computed(() => finalArchetype.value && profileData.value ? { description: profileData.value.teamRole } : {});

                const apiCall = async (body) => {
                    isSubmitting.value = true;
                    try {
                        const response = await fetch('/api/assessment', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                        if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                        return await response.json();
                    } catch (error) { console.error("API Call Error:", error); } finally { isSubmitting.value = false; }
                };
                
                const startTest = async () => {
                    const data = await apiCall({ action: 'start' });
                    if (data && data.question) { sessionId.value = data.sessionId; handleNewQuestion(data); }
                };

                const updatePoints = (index) => {
                    let overage = totalPoints.value - 10;
                    if (overage > 0) {
                        const otherIndices = Array.from(points.value.keys()).filter(i => i !== index);
                        for(let i of otherIndices) {
                           if (points.value[i] > 0) {
                               let reduction = Math.min(points.value[i], overage);
                               points.value[i] -= reduction;
                               overage -= reduction;
                               if(overage <= 0) break;
                           }
                        }
                    }
                };
                
                const submitAnswer = async () => {
                    let data;
                    if (screen.value === 'assessment') {
                        const answers = {};
                        currentQuestion.value.options.forEach((opt, i) => { answers[opt.domain] = points.value[i]; });
                        data = await apiCall({ action: 'submitAnswer', sessionId: sessionId.value, payload: { answers } });
                    } else if (screen.value === 'archetypeAssessment') {
                        const rankedArchetypes = rankedOptions.value.map(opt => opt.archetype);
                        data = await apiCall({ action: 'submitArchetypeRanking', sessionId: sessionId.value, payload: { rankedArchetypes } });
                    }
                    if(data) handleBackendResponse(data);
                };

                const handleBackendResponse = (data) => {
                     if (!data) return;
                     if (data.status === 'nextQuestion') { handleNewQuestion(data); }
                     else if (data.status === 'archetypeQuestion') { handleNewQuestion(data); }
                     else if (data.status === 'finalResults') {
                         primaryDomain.value = data.primaryDomain;
                         finalArchetype.value = data.finalArchetype.charAt(0).toUpperCase() + data.finalArchetype.slice(1);
                         profileData.value = data.profileData;
                         screen.value = 'finalResults';
                     }
                };
                
                const handleNewQuestion = (data) => {
                    currentQuestion.value = data.question;
                    questionNumber.value = data.questionNumber;
                    if (data.status === 'archetypeQuestion') {
                        primaryDomain.value = data.primaryDomain;
                        rankedOptions.value = [...data.question.options];
                        screen.value = 'archetypeAssessment';
                    } else {
                         const numOptions = data.question.options.length;
                         points.value = Array(numOptions).fill(Math.floor(10 / numOptions));
                         let remainder = 10 % numOptions;
                         for(let i=0; i<remainder; i++) { points.value[i]++; }
                         screen.value = 'assessment';
                    }
                };
                
                const moveRank = (index, direction) => {
                    const newIndex = index + direction;
                    if (newIndex < 0 || newIndex >= rankedOptions.value.length) return;
                    const item = rankedOptions.value.splice(index, 1)[0];
                    rankedOptions.value.splice(newIndex, 0, item);
                };
                
                const resetTest = () => { screen.value = 'start'; isSubmitting.value = false; };

                return { screen, isSubmitting, currentQuestion, questionNumber, points, rankedOptions, totalPoints, primaryDomain, finalArchetype, profileData, domainInfo, archetypeInfo, archetypeSprite, startTest, updatePoints, submitAnswer, resetTest, moveRank };
            }
        });
        app.mount('#app');
    </script>
</body>
</html>